<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PCP - Painel de Controle</title>
    <link rel="icon" href="ico.png" type="image/png">
    <link rel="icon" href="logo.png" type="image/png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- BIBLIOTECAS PDF ATUALIZADAS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- FIREBASE (Banco de dados em tempo real) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO SEU BANCO DE DADOS (PREENCHA AQUI PARA GITHUB/PRODUÇÃO) ---
        // 1. Vá em https://console.firebase.google.com/
        // 2. Crie um projeto e adicione um app Web
        // 3. Copie as configurações e cole abaixo entre as aspas:
        const suaConfiguracaoPessoal = {
            apiKey: "COLE_SUA_API_KEY_AQUI",
            authDomain: "SEU_PROJETO.firebaseapp.com",
            projectId: "SEU_PROJECT_ID",
            storageBucket: "SEU_PROJETO.appspot.com",
            messagingSenderId: "SEU_MESSAGING_SENDER_ID",
            appId: "SEU_APP_ID"
        };

        // Lógica para detectar se está no Chat (Teste) ou no seu GitHub (Produção)
        let firebaseConfig;
        let dbCollectionPath;

        if (typeof __firebase_config !== 'undefined') {
            // Ambiente de Teste (Chat)
            console.log("Ambiente: Teste/Chat");
            firebaseConfig = JSON.parse(__firebase_config);
            const envAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            dbCollectionPath = `artifacts/${envAppId}/public/data/pcp_conclusoes`;
        } else {
            // Ambiente de Produção (GitHub/Seu PC)
            console.log("Ambiente: Produção (Usando suaConfiguracaoPessoal)");
            const firebaseConfig = {
                apiKey: "AIzaSyA5DVhNqTe-kDygovMqZR1vU4TORvVKtOo",
                authDomain: "controle-producao-f444a.firebaseapp.com",
                projectId: "controle-producao-f444a",
                storageBucket: "controle-producao-f444a.firebasestorage.app",
                messagingSenderId: "947022562404",
                appId: "1:947022562404:web:270b482836081c65e98b71"
                };
            
            dbCollectionPath = "pcp_conclusoes"; // Nome da coleção no seu banco pessoal
        }
        
        // Inicialização
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.isAdmin = false;
        
        signInAnonymously(auth).then(() => {
            console.log("Conectado ao Firebase.");
            iniciarEscutaEmTempoReal();
        }).catch((error) => {
            console.error("Erro na conexão Firebase:", error);
            // Se der erro (ex: config vazia), avisa na interface
            document.getElementById('data-status').textContent = "Modo Offline (Sem Sync)";
        });

        function iniciarEscutaEmTempoReal() {
            try {
                const q = collection(db, dbCollectionPath);
                onSnapshot(q, (snapshot) => {
                    const novosStatus = {};
                    snapshot.forEach((doc) => { novosStatus[doc.id] = true; });
                    window.completionStatus = novosStatus;
                    if (typeof window.updateAllVisuals === 'function') {
                        window.updateAllVisuals();
                    }
                    document.getElementById('data-status').textContent = "Online • Sincronizado";
                    document.getElementById('data-status').classList.add('text-green-500');
                }, (error) => {
                    console.error("Erro no Snapshot:", error);
                    document.getElementById('data-status').textContent = "Erro Sync (Verifique Permissões)";
                });
            } catch (e) {
                console.error("Falha ao iniciar escuta:", e);
            }
        }

        window.saveItemStatusToCloud = async function(itemId, isChecked) {
            const docId = itemId.replace(/\//g, '_'); 
            // Usa o caminho definido dinamicamente
            const docRef = doc(db, dbCollectionPath, docId);
            try {
                if (isChecked) {
                    await setDoc(docRef, { completed: true, timestamp: new Date().toISOString(), user: 'admin' });
                } else {
                    await deleteDoc(docRef);
                }
            } catch (e) {
                console.error("Erro cloud:", e);
                // Não alerta toda vez se estiver sem config, apenas loga
                if (firebaseConfig.apiKey !== "COLE_SUA_API_KEY_AQUI") {
                    alert("Erro de sincronização. Verifique a internet ou permissões do Firestore.");
                }
                window.updateAllVisuals(); // Reverte visualmente se falhar
            }
        }
    </script>

    <style>
        :root {
            --bg-primary: #0D1117;
            --bg-secondary: #161B22;
            --border-color: #30363D;
            --text-primary: #C9D1D9;
            --text-secondary: #8B949E;
            --accent-primary: #983A1E;
            --accent-primary1: #C9D1D9;
            --accent-secondary: #E1D7C7;
            --highlight-white: #C9D1D9;
            --highlight-green: #238636;
            --highlight-bg-red: rgba(218, 54, 51, 0.15);
            --highlight-bg-green: rgba(35, 134, 54, 0.15);
            --completed-bg: #21262d;
            --completed-text: #8B949E;
            --icon-completed-color: #238636;
            --icon-partial-color: #D97706;
        }
        body { background-color: var(--bg-primary); color: var(--text-primary); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        .table-container { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-top: 1rem; border: 1px solid var(--border-color); }
        th, td { border: 1px solid var(--border-color); padding: 0.75rem 1rem; text-align: left; white-space: nowrap; }
        th { background-color: #21262D; color: var(--text-primary); font-weight: 600; position: sticky; top: 0; z-index: 10; }
        tbody tr:nth-child(even):not(.completed-row) { background-color: rgba(22, 27, 34, 0.5); }
        tbody tr:hover:not(.completed-row) { background-color: #21262D; }
        .completed-row td { background-color: var(--completed-bg) !important; color: var(--completed-text); text-decoration: line-through; }
        .completed-row td input[type="checkbox"] { opacity: 0.7; }
        
        input[type="checkbox"]:disabled { cursor: not-allowed; opacity: 0.3; filter: grayscale(100%); }

        .po-status-icon { margin-left: 0.5rem; font-size: 0.9em; font-weight: bold; display: inline-block; }
        .po-status-completed { color: var(--icon-completed-color); }
        .po-status-partial { color: var(--icon-partial-color); }
        .metric-card { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1.5rem; text-align: center; }
        .metric-label { color: var(--text-secondary); font-size: 0.875rem; margin-bottom: 0.5rem; display: block; }
        .metric-value { font-size: 1.875rem; font-weight: 600; color: var(--text-primary); }
        .btn { background-color: var(--accent-primary); color: var(--bg-primary); padding: 0.5rem 1rem; border-radius: 6px; font-weight: 500; cursor: pointer; transition: background-color 0.2s; border: none; }
        .btn:hover { background-color: var(--accent-secondary); }
        .btn.btn-secondary { background-color: var(--bg-secondary); color: var(--accent-primary1); border: 1px solid var(--border-color); }
        .btn.btn-secondary:hover { background-color: var(--accent-secondary); color: var(--bg-primary); border-color: var(--accent-secondary); }
        .btn-global-export { background-color: #983A1E; color: #000000; font-weight: bold; padding: 0.75rem 1.5rem; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-global-export:hover { background-color: #E1D7C7; }

        .btn-filter { background-color: var(--bg-secondary); color: var(--accent-primary1); padding: 0.25rem 0.75rem; border-radius: 4px; font-size: 0.75rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s, color 0.2s; border: 1px solid var(--border-color); margin-right: 0.5rem; }
        .btn-filter:hover { background-color: var(--accent-secondary); color: var(--bg-primary); border-color: var(--accent-secondary); }
        
        .po-select-list { background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary); width: 100%; border-radius: 6px; padding: 0.5rem; height: 10rem; overflow-y: auto; -webkit-tap-highlight-color: transparent; }
        .po-select-list option { padding: 0.25rem 0.5rem; font-size: 0.75rem; white-space: nowrap; color: var(--text-primary); background-color: var(--bg-secondary); cursor: pointer; }
        .po-select-list option:checked, .po-select-list option:hover:checked { background-color: var(--accent-secondary); color: var(--bg-primary); font-weight: bold; }
        .po-select-list option:hover:not(:checked) { background-color: #21262D; }

        .status-box { padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; transition: opacity 0.5s ease-out; }
        .status-loading { background-color: rgba(251, 191, 36, 0.1); border: 1px solid #D97706; color: #FBBF24; }
        .status-success { background-color: rgba(16, 185, 129, 0.1); border: 1px solid #059669; color: #34D399; }
        .status-error { background-color: rgba(239, 68, 68, 0.1); border: 1px solid #DC2626; color: #F87171; }
        .highlight-red { background-color: var(--highlight-bg-red); color: var(--highlight-white); font-weight: bold; }
        .highlight-green { background-color: var(--highlight-bg-green); color: var(--highlight-green); font-weight: bold; }
        @keyframes pulse-red { 0%, 100% { background-color: var(--highlight-bg-red); } 50% { background-color: rgba(218, 54, 51, 0.3); } }
        .pulse-red { animation: pulse-red 2s infinite ease-in-out; }
        #completed-po-scroller { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 0.5rem 0; margin-bottom: 1.5rem; overflow: hidden; height: 2.5rem; display: none; white-space: nowrap; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1); }
        #scroller-content { display: inline-block; padding-left: 100%; animation: scroll-left 30s linear infinite; color: var(--icon-completed-color); font-weight: bold; font-size: 0.875rem; line-height: 1.5rem; }
        @keyframes scroll-left { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }
        #completed-po-scroller:hover #scroller-content { animation-play-state: paused; }
        
        /* MODAL */
        .modal-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.7); z-index: 40; transition: opacity 0.2s ease-in-out; }
        .modal-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; z-index: 50; width: 90%; max-width: 50rem; max-height: 90vh; display: none; flex-direction: column; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-color); }
        .modal-title { font-size: 1.25rem; font-weight: 600; }
        .modal-close-btn { font-size: 1.875rem; font-weight: bold; color: var(--text-secondary); cursor: pointer; line-height: 1; }
        .modal-close-btn:hover { color: var(--text-primary); }
        .modal-content { padding: 1.5rem; overflow-y: auto; }
        .modal-footer { padding: 1rem 1.5rem; border-top: 1px solid var(--border-color); background-color: var(--bg-primary); text-align: right; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
        .mrp-table-modal { width: 100%; border-collapse: collapse; margin: 0; border: none; }
        .mrp-table-modal th, .mrp-table-modal td { border: 1px solid var(--border-color); padding: 0.5rem 1rem; white-space: normal; font-size: 0.875rem; }
        .mrp-table-modal th { background-color: #2c313a; }
        .mrp-toggle-icon { cursor: pointer; font-weight: bold; font-size: 1.25rem; color: var(--accent-primary1); user-select: none; display: inline-block; width: 20px; text-align: center; }
        .mrp-toggle-icon:hover { color: var(--accent-secondary); }
        
        /* ADMIN BTN */
        .admin-status { font-size: 0.75rem; padding: 0.25rem 0.5rem; border-radius: 4px; margin-bottom: 1rem; text-align: center; border: 1px solid transparent; cursor: pointer; }
        .admin-locked { border-color: #30363D; color: #8B949E; background-color: #161B22; }
        .admin-unlocked { border-color: #238636; color: #3fb950; background-color: rgba(35, 134, 54, 0.1); }
    </style>
</head>
<body class="grid grid-cols-12 gap-4 p-4 min-h-screen">

    
    <aside class="col-span-12 md:col-span-2 card flex flex-col">
        <img id="logo" src="logo.png" alt="Logo" class="mb-5 max-h-17 object-contain self-center" onerror="this.style.display='none'; document.getElementById('logo-error').style.display='block';">
        <p id="logo-error" class="text-xs text-red-400 text-center mb-4" style="display: none;">Logo não encontrada</p>

        <!-- BOTÃO DE LOGIN/STATUS ADMIN -->
        <div id="admin-btn" class="admin-status admin-locked" onclick="toggleAdmin()">
            <i class="fas fa-lock mr-2"></i> Acesso: Visitante
        </div>

        <button id="reload-button" class="btn w-full mb-6">Recarregar Dados</button>

        <a href="https://app.powerbi.com/links/B8TF3aTy_D?ctid=00efaec3-2fdf-400e-ab1c-0a8efb39d281&pbi_source=linkShare" 
           class="btn-filter flex items-center w-full justify-center" 
           target="_blank">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/cf/New_Power_BI_Logo.svg/2048px-New_Power_BI_Logo.svg.png" 
                 alt="Logotipo do Power BI" style="width: 20px; height: 20px; border: none;" class="mr-2">
           Dashboard De Produção
        </a>

        <br><br>
        
        <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Filtro de POs</h2>
        <div class="mb-2">
            <button id="select-all-po" class="btn-filter">Selecionar Todas</button>
            <button id="clear-all-po" class="btn-filter">Limpar Seleção</button>
        </div>
        <div id="po-filter-container" class="mb-2 flex-grow overflow-y-auto" style="height: 10rem;">
            <p id="po-loading" class="text-sm text-gray-400">Carregando POs...</p>
             <select id="po-select" multiple class="po-select-list"></select>
        </div>
        <p id="po-empty" class="text-sm text-green-400 hidden">Nenhum pedido pendente!</p>
        
        <h2 class="text-lg font-semibold mb-3 border-b border-gray-700 pb-2">Filtro de POs</h2>
        <p class="text-xs text-gray-400 mb-2">Selecione aqui POs para *subtrair* do estoque.</p>
        <div class="mb-2">
            <button id="select-all-po-reserva" class="btn-filter">Selecionar Todas</button>
            <button id="clear-all-po-reserva" class="btn-filter">Limpar Seleção</button>
        </div>
        <div id="po-filter-container-reserva" class="mb-4 flex-grow overflow-y-auto" style="height: 10rem;">
            <p id="po-loading-reserva" class="text-sm text-gray-400">Carregando POs...</p>
             <select id="po-select-reserva" multiple class="po-select-list"></select>
        </div>
        <p id="po-empty-reserva" class="text-sm text-green-400 hidden">Nenhum pedido pendente!</p>
        
        <div class="mt-auto border-t border-gray-700 pt-4">
            <div id="data-status" class="text-xs text-gray-400">Verificando...</div>
             <div id="data-last-updated" class="text-xs text-gray-500 mt-1"></div>
             <p class="text-xs text-gray-500 mt-2">Versão: 2.1.0 (Sync)</p>
             <p class="text-xs text-gray-500 mt-2">© Copyright 2025 Flora_Exportadora</p>
             <p class="text-xs text-gray-500 mt-2">Desenvolvido por Tales_Solidade</p>
        </div>
    </aside>

    
    <main class="col-span-12 md:col-span-10">
       
        <div class="card mb-4 flex flex-row justify-between items-center">
             <div>
                 <h1 class="text-2xl font-bold mb-1">PCP - PLANEJAMENTO E CONTROLE DE PRODUÇÃO</h1>
                 <p id="painel-info" class="text-sm text-gray-400"></p>
             </div>
             
             <img src="EXPAMA.png" alt="Logo Direita" class="max-h-6 object-contain ml-4" onerror="this.style.display='none'">
        </div>

        <div id="completed-po-scroller">
            <div id="scroller-content"></div>
        </div>

        <div id="global-status" class="status-box status-loading">Status: Carregando dados...</div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Volume de Pedidos em Carteira Total</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="metric-card">
                    <span class="metric-label">Total de POs em Carteira</span>
                    <span id="metric-pos" class="metric-value">0 POs</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">Total de Pacotes em Carteira</span>
                    <span id="metric-pacotes" class="metric-value">0 pcts</span>
                </div>
                <div class="metric-card">
                    <span class="metric-label">Total de M³ em Carteira</span>
                    <span id="metric-m3" class="metric-value">0.000 m³</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-2">MPS - Plano Mestre de Produção</h2>
            <div class="table-container">
                <table id="dashboard-table">
                    <thead>
                        <tr>
                            <th style="width: 20px;">MRP</th> 
                            <th>Produto</th>
                            <th>Perfil</th>
                            <th>M³ Carteira</th>
                            <th>M³ Estoque</th>
                            <th>Pacotes Carteira</th>
                            <th>Pacotes Estoque</th>
                            <th>M³ A produzir</th>
                            <th>Pacotes A produzir</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td colspan="9" class="text-center text-gray-500 py-4">Calculando...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button id="btn-global-mrp-pdf" class="btn btn-global-export">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="mr-2">
                      <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
                      <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
                    </svg>
                      MRP - Exportar Lista de Compras (PDF)
                </button>
            </div>
        </div>

        <div class="card">
            <h2 class="text-xl font-semibold mb-4">Tabela de Itens em Carteira</h2>
            <p class="text-xs text-gray-500 mb-2 italic">* Apenas administradores podem alterar o status de conclusão.</p>
             <div class="table-container">
                <table id="detail-table">
                    <thead>
                        <tr>
                            <th>Concluído?</th>
                            <th>PO</th>
                            <th>Cliente</th>
                            <th>Perfil</th>
                            <th>Produto</th>
                            <th>Em Carteira Pacotes</th>
                            <th>Em Carteira M³</th>
                        </tr>
                    </thead>
                    <tbody>
                          <tr><td colspan="7" class="text-center text-gray-500 py-4">Calculando...</td></tr>
                    </tbody>
                </table>
             </div>
             <p id="detail-empty" class="text-sm text-green-400 mt-4 hidden">Nenhum item em carteira para as POs selecionadas!</p>
        </div>
    </main>

    <!-- 
      MODAL (POPUP)
    -->
    <div id="mrp-modal-overlay" class="modal-overlay" onclick="hideMRPModal()"></div>
    <div id="mrp-modal-container" class="modal-container">
        <!-- CABEÇALHO -->
        <div class="modal-header">
            <h3 id="mrp-modal-title" class="modal-title">Necessidade de Insumos</h3>
            <span id="mrp-modal-close" class="modal-close-btn" onclick="hideMRPModal()">&times;</span>
        </div>
        
        <!-- CONTEÚDO (TABELA) -->
        <div id="mrp-modal-content" class="modal-content">
            <p>Calculando...</p>
        </div>
        
        <!-- RODAPÉ -->
        <div class="modal-footer">
            <button id="export-mrp-pdf" class="btn btn-secondary">
                Exportar PDF 
            </button>
        </div>
    </div>
    
    <!-- Script de Carregamento Dinâmico (Restaurado) -->
    <script id="script-dados" src=""></script>

    <!-- SCRIPT PRINCIPAL -->
    <script> 
        const CAMINHO_JS = "dados_atuais.js";
        let ALL_PENDING_ITEMS = []; 
        let ALL_STOCK_ITEMS = [];
        let ALL_BOM_DATA = [];
        
        let uniquePOs = [];
        let selectedPOs = new Set();
        let reservedPOs = new Set(); 
        let lastDataLoadTime = null;
        let globalStatusTimeout = null;
        
        // window.completionStatus agora é gerenciado pelo Firebase
        window.completionStatus = {};
        
        let bomCache = new Map();
        let G_FILTERED_PENDING_ITEMS = [];
        let G_DASHBOARD_DATA = [];

        // === FUNÇÃO DE ADMINISTRAÇÃO (SEGURANÇA SIMPLES) ===
        // Função de hash simples para não deixar a senha em texto plano
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash = hash & hash; // Converte para inteiro 32bit
            }
            return hash;
        }

        function toggleAdmin() {
            if (window.isAdmin) {
                window.isAdmin = false;
                updateAdminUI();
                alert("Você saiu do modo administrador.");
            } else {
                const senha = prompt("Digite a senha de administrador:");
                if (senha) {
                    // Hash de 'pcp' é 110813
                    if (simpleHash(senha) === 110813) {
                        window.isAdmin = true;
                        updateAdminUI();
                    } else {
                        alert("Senha incorreta.");
                    }
                }
            }
            renderDetailTable(G_FILTERED_PENDING_ITEMS);
        }

        function updateAdminUI() {
            const btn = document.getElementById('admin-btn');
            if (window.isAdmin) {
                btn.className = 'admin-status admin-unlocked';
                btn.innerHTML = '<i class="fas fa-unlock mr-2"></i> Acesso: Admin (PCP)';
            } else {
                btn.className = 'admin-status admin-locked';
                btn.innerHTML = '<i class="fas fa-lock mr-2"></i> Acesso: Visitante';
            }
        }
        
        function formatNumber(num, decimals = 0) {
            if (typeof num !== 'number' || isNaN(num)) return '0';
            return num.toLocaleString('pt-BR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }
        function formatM3(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0.000 m³';
            return num.toLocaleString('pt-BR', { minimumFractionDigits: 3, maximumFractionDigits: 3 }) + ' m³';
        }
         function formatPct(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0 pcts';
            return formatNumber(Math.round(num), 0) + ' pcts';
         }
        function formatPO(num) {
            if (typeof num !== 'number' || isNaN(num)) return '0 POs';
            return formatNumber(num, 0) + ' POs';
        }

        function getPecasPorPacote(perfil) { return perfil === 'LS4S' ? 294 : 420; }
        
        function calcularResumoTotal(pendingItems) {
            const itemsEmCarteira = pendingItems.filter(item => (item.Pendente_Pecas || 0) > 0 || (item.Pendente_M3 || 0) > 0.001);
            const totalPOs = new Set(itemsEmCarteira.map(item => item.PO)).size;
            let totalPacotes = 0; let totalM3 = 0;
            itemsEmCarteira.forEach(item => {
                const pendentePecas = item.Pendente_Pecas || 0;
                totalM3 += item.Pendente_M3 || 0;
                if (pendentePecas > 0) {
                    totalPacotes += Math.round(pendentePecas / getPecasPorPacote(item.Perfil));
                }
            });
            return { totalPOs, totalPacotes, totalM3 };
        }
        
        function calcularDashboard(filteredItems, adjustedStockItems) {
            const carteiraAgrupada = filteredItems.reduce((acc, item) => {
                const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                if (!acc[key]) acc[key] = { Produto: item.Produto, Perfil: item.Perfil, Solicitado_Pecas: 0, Solicitado_M3: 0 };
                acc[key].Solicitado_Pecas += item.Pendente_Pecas || 0; acc[key].Solicitado_M3 += item.Pendente_M3 || 0; return acc;
            }, {});
            const estoqueMap = adjustedStockItems.reduce((acc, item) => {
                 const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                 acc[key] = { M3_Estoque_Liquido: item.M3_Estoque_Liquido || 0, Pecas_Estoque_Liquido: item.Pecas_Estoque_Liquido || 0 }; return acc;
            }, {});
            const dashboardData = [];
            Object.values(carteiraAgrupada).forEach(carteiraItem => {
                const key = `${carteiraItem.Produto || 'N/A'}|${carteiraItem.Perfil || 'N/A'}`;
                const estoqueItem = estoqueMap[key] || { M3_Estoque_Liquido: 0, Pecas_Estoque_Liquido: 0 };
                const pecasPorPacote = getPecasPorPacote(carteiraItem.Perfil);
                const m3Carteira = carteiraItem.Solicitado_M3; const pecasCarteira = carteiraItem.Solicitado_Pecas;
                const m3Estoque = estoqueItem.M3_Estoque_Liquido; const pecasEstoque = estoqueItem.Pecas_Estoque_Liquido;
                const m3AProduzir = Math.max(0, m3Carteira - m3Estoque); const pecasAProduzir = Math.max(0, pecasCarteira - pecasEstoque);
                
                const pacotesCarteira = Math.round(pecasCarteira / pecasPorPacote);
                const pacotesEstoque = Math.floor(pecasEstoque / pecasPorPacote);
                const pacotesAProduzir = Math.round(pecasAProduzir / pecasPorPacote);

                dashboardData.push({
                    Produto: carteiraItem.Produto, Perfil: carteiraItem.Perfil,
                    M3_Carteira_Volume: m3Carteira, M3_Estoque_Liquido: m3Estoque,
                    Pacotes_Carteira: pacotesCarteira, Pacotes_Estoque: pacotesEstoque,
                    M3_A_Produzir: m3AProduzir, Pacotes_A_Produzir: pacotesAProduzir,
                });
            });
             adjustedStockItems.forEach(item => {
                const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`;
                 if (!carteiraAgrupada[key] && (item.Pecas_Estoque_Liquido > 0 || item.M3_Estoque_Liquido > 0.001)) {
                       dashboardData.push({
                             Produto: item.Produto, Perfil: item.Perfil, M3_Carteira_Volume: 0, M3_Estoque_Liquido: item.M3_Estoque_Liquido,
                             Pacotes_Carteira: 0, Pacotes_Estoque: Math.floor(item.Pecas_Estoque_Liquido / getPecasPorPacote(item.Perfil)),
                             M3_A_Produzir: 0, Pacotes_A_Produzir: 0,
                       });
                  }
            });
             dashboardData.sort((a, b) => { const pc = (a.Produto || '').localeCompare(b.Produto || ''); return pc !== 0 ? pc : (a.Perfil || '').localeCompare(b.Perfil || ''); });
            
            G_DASHBOARD_DATA = dashboardData;
            
            return dashboardData.filter(item => item.M3_Carteira_Volume > 0.001 || item.M3_Estoque_Liquido > 0.001);
        }

        
        function renderPOFilters() {
            const poSelect = document.getElementById('po-select'); const poEmpty = document.getElementById('po-empty'); const poLoading = document.getElementById('po-loading');
            const poSelectReserva = document.getElementById('po-select-reserva'); const poEmptyReserva = document.getElementById('po-empty-reserva'); const poLoadingReserva = document.getElementById('po-loading-reserva');
            poSelect.innerHTML = ''; poSelectReserva.innerHTML = '';
            if (uniquePOs.length === 0) {
                 poLoading.style.display = 'none'; poEmpty.style.display = 'block'; poSelect.style.display = 'none';
                 poLoadingReserva.style.display = 'none'; poEmptyReserva.style.display = 'block'; poSelectReserva.style.display = 'none';
                 return;
            }
            poLoading.style.display = 'none'; poEmpty.style.display = 'none'; poSelect.style.display = 'block';
            poLoadingReserva.style.display = 'none'; poEmptyReserva.style.display = 'none'; poSelectReserva.style.display = 'block';
            uniquePOs.forEach(po => {
                const optionMain = document.createElement('option'); optionMain.value = po; optionMain.textContent = po; optionMain.selected = selectedPOs.has(po);
                poSelect.appendChild(optionMain);
                const optionReserva = document.createElement('option'); optionReserva.value = po; optionReserva.textContent = po; optionReserva.selected = reservedPOs.has(po);
                poSelectReserva.appendChild(optionReserva);
            });
        }
        function renderSummary(summary) { document.getElementById('metric-pos').textContent = formatPO(summary.totalPOs); document.getElementById('metric-pacotes').textContent = formatPct(summary.totalPacotes); document.getElementById('metric-m3').textContent = formatM3(summary.totalM3); }
        
        function renderDashboard(dashboardData) {
            const tbody = document.getElementById('dashboard-table').querySelector('tbody'); 
            tbody.innerHTML = ''; 
            
            if (dashboardData.length === 0) { 
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">Nenhum dado para exibir.</td></tr>`; 
                return; 
            }
            
            dashboardData.forEach(item => {
                const am3 = item.M3_A_Produzir || 0;
                const apct = item.Pacotes_A_Produzir || 0;
                const cm3 = am3 > 0.001 ? 'highlight-red' : '';
                const cpct = apct > 0 ? 'highlight-red' : '';
                const pm3 = cm3 ? ' pulse-red' : '';
                const ppct = cpct ? ' pulse-red' : '';
                
                let toggleIcon = '';
                if (am3 > 0.001) {
                    toggleIcon = `<span class="mrp-toggle-icon" 
                                        onclick="showMRPModal('${item.Produto}', '${item.Perfil}')">
                                      +
                                  </span>`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="text-center">${toggleIcon}</td>
                    <td>${item.Produto || 'N/A'}</td>
                    <td>${item.Perfil || 'N/A'}</td>
                    <td>${formatM3(item.M3_Carteira_Volume)}</td>
                    <td>${formatM3(item.M3_Estoque_Liquido)}</td>
                    <td>${formatPct(item.Pacotes_Carteira)}</td> 
                    <td>${formatPct(item.Pacotes_Estoque)}</td>
                    <td class="${cm3}${pm3}">${formatM3(am3)}</td>
                    <td class="${cpct}${ppct}">${formatPct(apct)}</td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderDetailTable(filteredItems) {
            const tbody = document.getElementById('detail-table').querySelector('tbody'); const emptyMsg = document.getElementById('detail-empty'); tbody.innerHTML = '';
               if (filteredItems.length === 0) { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-500 py-4">${(selectedPOs.size === 0 && uniquePOs.length > 0) ? 'Nenhuma PO selecionada.' : 'Nenhum item encontrado.'}</td></tr>`; emptyMsg.style.display = 'block'; renderCompletedPOScroller([]); return; }
               emptyMsg.style.display = 'none';
               const poStatusMap = {}; const poCompletionState = {}; const completedPOs = [];
               filteredItems.forEach(item => { const po = item.PO || 'na'; const itemId = generateItemId(item); if (!poStatusMap[po]) poStatusMap[po] = { total: 0, completed: 0 }; poStatusMap[po].total++; if (window.completionStatus[itemId] === true) poStatusMap[po].completed++; });
               for (const po in poStatusMap) { if (poStatusMap[po].completed === 0) poCompletionState[po] = 'pending'; else if (poStatusMap[po].completed === poStatusMap[po].total) {poCompletionState[po] = 'full'; completedPOs.push(po);} else poCompletionState[po] = 'partial'; }
               completedPOs.sort();
            filteredItems.sort((a, b) => { const pc = (a.PO || '').localeCompare(b.PO || ''); return pc !== 0 ? pc : (a.Produto || '').localeCompare(b.Produto || ''); });
            
            filteredItems.forEach(item => {
                const itemId = generateItemId(item); 
                const isItemCompleted = window.completionStatus[itemId] === true; 
                const poState = poCompletionState[item.PO || 'na'];
                
                const emCarteiraPct = Math.round((item.Pendente_Pecas || 0) / getPecasPorPacote(item.Perfil)); const emCarteiraM3 = item.Pendente_M3 || 0;
                let rowClass = ''; let poIndicatorIcon = '';
                if (poState === 'full') { rowClass = 'completed-row'; poIndicatorIcon = '<span class="po-status-icon po-status-completed">✓</span>'; }
                else if (poState === 'partial') { poIndicatorIcon = '<span class="po-status-icon po-status-partial">⚠️</span>'; if (isItemCompleted) rowClass = 'completed-row';}
                else { if (isItemCompleted) rowClass = 'completed-row'; }
                
                // Lógica de Bloqueio do Checkbox
                const isDisabled = window.isAdmin ? '' : 'disabled';
                
                tbody.innerHTML += `
                        <tr class="${rowClass}" data-item-id="${itemId}"> 
                            <td class="text-center">
                                <input type="checkbox" class="form-checkbox h-4 w-4" ${isItemCompleted ? 'checked' : ''} ${isDisabled} onchange="toggleItemCompletion(this)">
                            </td> 
                            <td>${item.PO || 'N/A'}${poIndicatorIcon}</td> 
                            <td>${item.Cliente || 'N/A'}</td> 
                            <td>${item.Perfil || 'N/A'}</td> 
                            <td>${item.Produto || 'N/A'}</td> 
                            <td>${formatPct(emCarteiraPct)}</td> 
                            <td>${formatM3(emCarteiraM3)}</td> 
                        </tr>`;
            });
               renderCompletedPOScroller(completedPOs);
        }
        function renderCompletedPOScroller(completedPOs) {
             const scrollerC = document.getElementById('completed-po-scroller'); const scrollerCt = document.getElementById('scroller-content');
             if (completedPOs.length > 0) { scrollerCt.textContent = "POs Concluídas: " + completedPOs.join(' ✓ | ') + ' ✓'; scrollerC.style.display = 'block'; }
             else { scrollerC.style.display = 'none'; scrollerCt.textContent = ''; }
        }


        // --- MRP I ---
        
        function getItemKey(item) {
            const p = item.Produto || 'N/A';
            const f = item.Perfil || 'N/A';
            const e = (item.Espessura || 0).toFixed(5);
            const l = (item.Largura || 0).toFixed(5);
            const c = (item.Comprimento || 0).toFixed(5);
            return `${p}|${f}|${e}|${l}|${c}`;
        }

        function buildBomCache(bomData) {
            bomCache.clear();
            if (!bomData) return;
            bomData.forEach(item => {
                const bomItem = {
                    Produto: item.Produto, Perfil: item.Perfil,
                    Espessura: item.Espessura, Largura: item.Largura, Comprimento: item.Comprimento,
                    Componente: item.Componente, Consumo_M3: item.Consumo_M3,
                    Consumo_Peca: item.Consumo_Peca, Unidade_Medida: item.Unidade_Medida,
                    Tipo_Insumo: item.Tipo_Insumo
                };
                const key = getItemKey(bomItem);
                if (!bomCache.has(key)) { bomCache.set(key, []); }
                bomCache.get(key).push(bomItem);
            });
        }
        
        function getRecipe(item) {
            const key = getItemKey(item);
            return bomCache.get(key) || [];
        }

        function calculateMRPForProduct(produto, perfil) {
            const mpsItem = G_DASHBOARD_DATA.find(d => d.Produto === produto && d.Perfil === perfil);
            if (!mpsItem || mpsItem.M3_A_Produzir <= 0.001) { return {}; }

            const m3TotalCarteira = mpsItem.M3_Carteira_Volume;
            const m3TotalAProduzir = mpsItem.M3_A_Produzir;
            const necessidadesAgregadas = {};

            const pendingItemsForProduct = G_FILTERED_PENDING_ITEMS.filter(item => 
                (item.Produto || 'N/A') === (produto || 'N/A') && 
                (item.Perfil || 'N/A') === (perfil || 'N/A')
            );
            
            pendingItemsForProduct.forEach(item => {
                let proporcaoItem = 0;
                if (m3TotalCarteira > 0.001) { proporcaoItem = (item.Pendente_M3 || 0) / m3TotalCarteira; }
                const m3ItemAProduzir = m3TotalAProduzir * proporcaoItem;
                
                if (m3ItemAProduzir > 0) {
                    const receita = getRecipe(item); 
                    receita.forEach(bomItem => {
                        const componente = bomItem.Componente;
                        const consumoM3 = bomItem.Consumo_M3 || 0;
                        const necessidadeBruta = m3ItemAProduzir * consumoM3;
                        if (!necessidadesAgregadas[componente]) {
                            necessidadesAgregadas[componente] = { necessidade: 0, unidade: bomItem.Unidade_Medida || 'N/A', tipo: bomItem.Tipo_Insumo || 'N/A' };
                        }
                        necessidadesAgregadas[componente].necessidade += necessidadeBruta;
                    });
                }
            });
            return necessidadesAgregadas;
        }

        function calculateGlobalMRP() {
            const globalNecessities = {};
            G_DASHBOARD_DATA.forEach(mpsItem => {
                const m3AProduzir = mpsItem.M3_A_Produzir || 0;
                if (m3AProduzir > 0.001) {
                    const productNecessities = calculateMRPForProduct(mpsItem.Produto, mpsItem.Perfil);
                    for (const [componente, data] of Object.entries(productNecessities)) {
                        if (!globalNecessities[componente]) {
                            globalNecessities[componente] = { necessidade: 0, unidade: data.unidade, tipo: data.tipo };
                        }
                        globalNecessities[componente].necessidade += data.necessidade;
                    }
                }
            });
            return globalNecessities;
        }

        function generateMRPTableHTML(necessidades) {
            const componentes = Object.keys(necessidades);
            if (componentes.length === 0) { return `<div class="p-4 text-center text-gray-400">Nenhum insumo encontrado na BOM para os itens a produzir.</div>`; }
            let tableHTML = `
                <table class="mrp-table-modal" id="mrp-export-table">
                    <thead><tr><th>INSUMOS</th><th>TIPO</th><th>UNIDADE</th><th>NECESSIDADE</th></tr></thead>
                    <tbody>
            `;
            componentes.sort();
            componentes.forEach(componente => {
                const item = necessidades[componente];
                let decimals = 3;
                const tipo = (item.tipo || '').toUpperCase();
                const unidade = (item.unidade || '').toUpperCase();
                if (tipo.includes('EMBALAGEM')) { decimals = 3; } else if (unidade === 'UN' || unidade === 'UD') { decimals = 0; }
                const formatoNumero = formatNumber(item.necessidade, decimals);
                tableHTML += `<tr><td>${componente}</td><td>${item.tipo}</td><td>${item.unidade}</td><td class="highlight-red">${formatoNumero}</td></tr>`;
            });
            tableHTML += `</tbody></table>`;
            return tableHTML;
        }

        window.showMRPModal = function(produto, perfil) {
            const overlay = document.getElementById('mrp-modal-overlay');
            const modal = document.getElementById('mrp-modal-container');
            const title = document.getElementById('mrp-modal-title');
            const content = document.getElementById('mrp-modal-content');
            title.textContent = `MRP I - INSUMOS DO ${produto} - ${perfil}`.toUpperCase();
            content.innerHTML = `<p class="text-center text-gray-400 py-4">Calculando necessidade...</p>`;
            overlay.style.display = 'block';
            modal.style.display = 'flex'; 
            setTimeout(() => {
                const necessidades = calculateMRPForProduct(produto, perfil);
                const tableHTML = generateMRPTableHTML(necessidades);
                content.innerHTML = tableHTML;
            }, 50); 
        }

        window.hideMRPModal = function() {
            document.getElementById('mrp-modal-overlay').style.display = 'none';
            document.getElementById('mrp-modal-container').style.display = 'none';
            document.getElementById('mrp-modal-content').innerHTML = ''; 
        }
        
        function exportMRPToPDF() {
            const { jsPDF } = window.jspdf;
            const modalTitleEl = document.getElementById('mrp-modal-title');
            const exportButton = document.getElementById('export-mrp-pdf');
            generatePDFWithAutoTable(jsPDF, modalTitleEl.textContent, '#mrp-export-table', exportButton);
        }

        function exportGlobalMRPToPDF() {
            const { jsPDF } = window.jspdf;
            const exportButton = document.getElementById('btn-global-mrp-pdf');
            const necessidadesGlobais = calculateGlobalMRP();
            const tableHTML = generateMRPTableHTML(necessidadesGlobais);
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute'; tempDiv.style.left = '-9999px'; tempDiv.innerHTML = tableHTML;
            document.body.appendChild(tempDiv);
            generatePDFWithAutoTable(jsPDF, "LISTA DE COMPRAS CONSOLIDADA (MRP GLOBAL)", tempDiv.querySelector('table'), exportButton, () => {
                document.body.removeChild(tempDiv);
            });
        }

        function generatePDFWithAutoTable(jsPDF, titleText, tableInput, buttonElement, callback) {
            const originalButtonText = buttonElement.innerHTML;
            buttonElement.innerHTML = "Gerando PDF..."; buttonElement.disabled = true;
            try {
                const doc = new jsPDF('p', 'mm', 'a4');
                const margin = 15; let startY = margin + 12;
                doc.setFontSize(14); doc.setTextColor('#0D1117'); doc.text(titleText, margin, startY); startY += 6; 
                doc.setFontSize(9); doc.setTextColor('#30363D'); doc.text(`Gerado em: ${new Date().toLocaleString('pt-BR')}`, margin, startY);
                if(titleText.includes("GLOBAL")) { startY += 5; const qtdPos = selectedPOs.size > 0 ? selectedPOs.size : "Todas"; doc.text(`Filtro POs: ${qtdPos} pedidos selecionados`, margin, startY); }
                startY += 8; 
                doc.autoTable({
                    html: tableInput, startY: startY, margin: { left: margin, right: margin }, theme: 'grid',
                    styles: { fillColor: '#F3F4F6', textColor: '#1F2937', lineColor: '#D1D5DB', lineWidth: 0.1, fontSize: 9 },
                    headStyles: { fillColor: 'black', textColor: '#FFFFFF', fontStyle: 'bold', },
                    didParseCell: function (data) { if (data.column.dataKey === 3) { data.cell.styles.textColor = '#DC2626'; data.cell.styles.fontStyle = 'bold'; } }
                });
                doc.save(`Relatorio_${titleText.replace(/[^a-z0-9]/gi, '_')}.pdf`);
            } catch (e) { alert("Ocorreu um erro ao gerar o PDF."); } finally { buttonElement.innerHTML = originalButtonText; buttonElement.disabled = false; if(callback) callback(); }
        }

        // --- Interações ---
        function selectAllPOs() { const poSelect = document.getElementById('po-select'); selectedPOs.clear(); for (let i = 0; i < poSelect.options.length; i++) { poSelect.options[i].selected = true; selectedPOs.add(poSelect.options[i].value); } poSelect.dispatchEvent(new Event('change')); updateDashboardAndDetail(); }
        function clearAllPOs() { const poSelect = document.getElementById('po-select'); for (let i = 0; i < poSelect.options.length; i++) poSelect.options[i].selected = false; selectedPOs.clear(); poSelect.dispatchEvent(new Event('change')); updateDashboardAndDetail(); }
        function handleMainPOSelectionChange() { const poSelect = document.getElementById('po-select'); selectedPOs.clear(); for (let i = 0; i < poSelect.selectedOptions.length; i++) selectedPOs.add(poSelect.selectedOptions[i].value); updateDashboardAndDetail(); }
        function selectAllPOsReserva() { const poSelect = document.getElementById('po-select-reserva'); reservedPOs.clear(); for (let i = 0; i < poSelect.options.length; i++) { poSelect.options[i].selected = true; reservedPOs.add(poSelect.options[i].value); } poSelect.dispatchEvent(new Event('change')); updateDashboardAndDetail(); }
        function clearAllPOsReserva() { const poSelect = document.getElementById('po-select-reserva'); for (let i = 0; i < poSelect.options.length; i++) poSelect.options[i].selected = false; reservedPOs.clear(); poSelect.dispatchEvent(new Event('change')); updateDashboardAndDetail(); }
        function handleReservationSelectionChange() { const poSelect = document.getElementById('po-select-reserva'); reservedPOs.clear(); for (let i = 0; i < poSelect.selectedOptions.length; i++) reservedPOs.add(poSelect.selectedOptions[i].value); updateDashboardAndDetail(); }

        function updateDashboardAndDetail() {
             if (!ALL_PENDING_ITEMS || !ALL_STOCK_ITEMS) return;
             const filteredItemsEmCarteira = ALL_PENDING_ITEMS.filter(item => { const poValue = item && item.PO ? String(item.PO) : null; return poValue && selectedPOs.has(poValue); });
             G_FILTERED_PENDING_ITEMS = filteredItemsEmCarteira;
             const itemsAReservar = ALL_PENDING_ITEMS.filter(item => { const poValue = item && item.PO ? String(item.PO) : null; return poValue && reservedPOs.has(poValue); });
             const reservedStockSummary = itemsAReservar.reduce((acc, item) => { const key = `${item.Produto || 'N/A'}|${item.Perfil || 'N/A'}`; if (!acc[key]) acc[key] = { Pecas_Reservadas: 0, M3_Reservados: 0 }; acc[key].Pecas_Reservadas += item.Pendente_Pecas || 0; acc[key].M3_Reservados += item.Pendente_M3 || 0; return acc; }, {});
             const adjustedStockItems = ALL_STOCK_ITEMS.map(stockItem => {
                 const key = `${stockItem.Produto || 'N/A'}|${stockItem.Perfil || 'N/A'}`; const reserva = reservedStockSummary[key]; let M3_Estoque_Liquido = stockItem.M3_Estoque_Liquido || 0; let Pecas_Estoque_Liquido = stockItem.Pecas_Estoque_Liquido || 0;
                 if (reserva) { M3_Estoque_Liquido -= reserva.M3_Reservados; Pecas_Estoque_Liquido -= reserva.Pecas_Reservadas; }
                 return { ...stockItem, M3_Estoque_Liquido, Pecas_Estoque_Liquido };
             });
             const dashboardData = calcularDashboard(filteredItemsEmCarteira, adjustedStockItems);
             renderDashboard(dashboardData);
             renderDetailTable(filteredItemsEmCarteira);
        }

        function generateItemId(item) {
             const po = (item.PO || 'na').replace(/[.\#$[\]/]/g, '_');
             const cli = (item.Cliente || 'na').replace(/[.\#$[\]/]/g, '_');
             const perf = (item.Perfil || 'na').replace(/[.\#$[\]/]/g, '_');
             const prod = (item.Produto || 'na').replace(/[.\#$[\]/]/g, '_');
             const e = (item.Espessura || 0).toFixed(5);
             const l = (item.Largura || 0).toFixed(5);
             const c = (item.Comprimento || 0).toFixed(5);
             return `${po}|${cli}|${perf}|${prod}|${e}|${l}|${c}`;
         }

        // --- LÓGICA DE CHECKBOX DO FIREBASE ---
        window.toggleItemCompletion = function(checkboxElement) {
             const row = checkboxElement.closest('tr'); 
             const itemId = row.getAttribute('data-item-id'); 
             const isChecked = checkboxElement.checked;
             const po = itemId.split('|')[0];
             
             if (!itemId || po === 'na') { console.error("ID inválido:", itemId); return; }
             
             // Atualiza visualmente imediatamente (otimismo)
             window.completionStatus[itemId] = isChecked;
             window.updatePOVisualStatus(po);
             
             // Envia para o banco de dados
             window.saveItemStatusToCloud(itemId, isChecked);
        }
        
        // Função para atualizar visual quando chega dado do banco
        window.updateAllVisuals = function() {
            // Re-renderiza a tabela atual para refletir novos status
            renderDetailTable(G_FILTERED_PENDING_ITEMS);
            // Atualiza barra de rolagem
            recalculateAndRenderScroller();
        }
        
        window.updatePOVisualStatus = function(po) {
             const tbody = document.getElementById('detail-table').querySelector('tbody');
             const rowsForPO = tbody.querySelectorAll(`tr[data-item-id^="${po}|"]`);
             if (rowsForPO.length === 0) { recalculateAndRenderScroller(); return; }
             let total = 0; let completed = 0;
             rowsForPO.forEach(r => { total++; const id = r.getAttribute('data-item-id'); if (window.completionStatus[id] === true) completed++; });
             let state = 'pending'; let icon = '';
             if (completed === 0) state = 'pending';
             else if (completed === total) { state = 'full'; icon = '<span class="po-status-icon po-status-completed">✓</span>';}
             else { state = 'partial'; icon = '<span class="po-status-icon po-status-partial">⚠️</span>';}
             rowsForPO.forEach(r => {
                 const poCell = r.cells[1]; const itemId = r.getAttribute('data-item-id'); const isItemDone = window.completionStatus[itemId] === true;
                 const poText = itemId.split('|')[0]; 
                 r.classList.remove('completed-row'); const existingIcon = poCell.querySelector('.po-status-icon'); if (existingIcon) existingIcon.remove();
                 poCell.textContent = poText;
                 if (state === 'full') { r.classList.add('completed-row'); poCell.innerHTML += icon; }
                 else if (state === 'partial') { poCell.innerHTML += icon; if (isItemDone) r.classList.add('completed-row'); }
                 else { if (isItemDone) r.classList.add('completed-row'); }
             });
             recalculateAndRenderScroller();
        }
        
        window.recalculateAndRenderScroller = function() {
             const completedPOsList = [];
             const allItemsByPO = ALL_PENDING_ITEMS.reduce((acc, item) => { const po = item.PO || 'na'; if (po === 'na') return acc; if (!acc[po]) acc[po] = []; acc[po].push(item); return acc; }, {});
             for (const po in allItemsByPO) {
                 const items = allItemsByPO[po]; let allDone = true;
                 if (items.length === 0) allDone = false;
                 else { for (const item of items) { const id = generateItemId(item); if (window.completionStatus[id] !== true) { allDone = false; break; }}}
                 if (allDone) completedPOsList.push(po);
             }
             completedPOsList.sort(); renderCompletedPOScroller(completedPOsList);
        }

        // --- CARREGAMENTO DE DADOS REAIS ---
        function carregarScriptDados() {
            const globalStatus = document.getElementById('global-status'); 
            const dataStatus = document.getElementById('data-status'); 
            const lastUpdated = document.getElementById('data-last-updated');
            
            globalStatus.textContent = `Carregando ${CAMINHO_JS}...`; 
            globalStatus.className = 'status-box status-loading'; 
            globalStatus.style.opacity = '1'; 
            if (globalStatusTimeout) clearTimeout(globalStatusTimeout);
            dataStatus.textContent = 'Carregando...'; 
            lastUpdated.textContent = '';
            
            const scriptAntigo = document.getElementById('script-dados'); if (scriptAntigo) scriptAntigo.remove();
            const ts = new Date().getTime(); const src = `${CAMINHO_JS}?v=${ts}`;
            const scriptNovo = document.createElement('script'); scriptNovo.id = 'script-dados'; scriptNovo.src = src;

            scriptNovo.onload = () => {
                lastDataLoadTime = new Date(); dataStatus.textContent = `'${CAMINHO_JS}' carregado.`; lastUpdated.textContent = `Atualizado: ${lastDataLoadTime.toLocaleTimeString('pt-BR')}`; console.log("Dados JS carregados.");
                
                if (typeof MOCK_ESTOQUE_LIQUIDO !== 'undefined' && 
                    typeof MOCK_DADOS_PENDENTES_DETALHADOS !== 'undefined' &&
                    typeof DADOS_BOM !== 'undefined') 
                {
                    ALL_STOCK_ITEMS = MOCK_ESTOQUE_LIQUIDO;
                    ALL_PENDING_ITEMS = MOCK_DADOS_PENDENTES_DETALHADOS.filter(item => (item.Pendente_Pecas || 0) > 0 || (item.Pendente_M3 || 0) > 0.001);
                    ALL_BOM_DATA = DADOS_BOM; 
                    
                    buildBomCache(ALL_BOM_DATA);

                    uniquePOs = [...new Set(ALL_PENDING_ITEMS.map(item => item.PO))].sort();
                    
                    if (ALL_PENDING_ITEMS.length === 0 && ALL_STOCK_ITEMS.length === 0) { 
                        globalStatus.textContent = `AVISO: '${CAMINHO_JS}' vazio.`; globalStatus.className = 'status-box status-loading'; uniquePOs = []; selectedPOs.clear(); reservedPOs.clear(); 
                    }
                    else {
                        const itemsEmCarteira = ALL_PENDING_ITEMS;
                        globalStatus.textContent = `SUCESSO: ${itemsEmCarteira.length} itens, ${ALL_STOCK_ITEMS.length} estoque, ${ALL_BOM_DATA.length} receitas BOM.`; 
                        globalStatus.className = 'status-box status-success'; globalStatusTimeout = setTimeout(() => { globalStatus.style.opacity = '0'; }, 3000); console.log("MOCKs ok.");
                        
                        selectedPOs = new Set([...selectedPOs].filter(po => uniquePOs.includes(po)));
                        reservedPOs = new Set([...reservedPOs].filter(po => uniquePOs.includes(po)));
                        if (selectedPOs.size === 0 && uniquePOs.length > 0) selectedPOs = new Set(uniquePOs);
                    }
                    
                    renderPOFilters();
                    const summary = calcularResumoTotal(ALL_PENDING_ITEMS);
                    renderSummary(summary);
                    
                    console.log("[v1.9.0] Dados JS carregados, chamando update...");
                    updateDashboardAndDetail();
                    
                } else { 
                    globalStatus.textContent = `ERRO: '${CAMINHO_JS}' ok, mas variáveis (MOCK_*, DADOS_BOM) não definidas.`; 
                    globalStatus.className = 'status-box status-error'; 
                    console.error("MOCKs ou DADOS_BOM não encontradas."); 
                }
            };
            
            scriptNovo.onerror = (e) => {
                globalStatus.textContent = `ERRO: Falha ao carregar '${CAMINHO_JS}'. Verifique o console.`; 
                globalStatus.className = 'status-box status-error'; 
                globalStatus.style.opacity = '1';
                dataStatus.textContent = 'Falha no carregamento.';
                console.error(`Erro ao carregar script: ${src}`, e);
                ALL_PENDING_ITEMS = []; ALL_STOCK_ITEMS = []; ALL_BOM_DATA = []; uniquePOs = []; selectedPOs.clear(); reservedPOs.clear();
                renderPOFilters(); 
                renderSummary({ totalPOs: 0, totalPacotes: 0, totalM3: 0 });
                renderDashboard([]); 
                renderDetailTable([]);
                
                if (document.getElementById('dashboard-table')) {
                    document.getElementById('dashboard-table').querySelector('tbody').innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">Erro ao carregar dados.</td></tr>`;
                }
            };

            document.head.appendChild(scriptNovo);
        }

        
        document.addEventListener('DOMContentLoaded', () => {
            const poSelect = document.getElementById('po-select');
            const poSelectReserva = document.getElementById('po-select-reserva');
            
            // Carrega os dados chamando o script externo
            carregarScriptDados(); 

            document.getElementById('reload-button').addEventListener('click', carregarScriptDados);
            document.getElementById('select-all-po').addEventListener('click', selectAllPOs);
            document.getElementById('clear-all-po').addEventListener('click', clearAllPOs);
            document.getElementById('select-all-po-reserva').addEventListener('click', selectAllPOsReserva);
            document.getElementById('clear-all-po-reserva').addEventListener('click', clearAllPOsReserva);

            document.getElementById('export-mrp-pdf').addEventListener('click', exportMRPToPDF);
            document.getElementById('btn-global-mrp-pdf').addEventListener('click', exportGlobalMRPToPDF);

             const handleInteraction = (event) => {
                 const selectElement = event.currentTarget;
                 const currentScrollTop = selectElement.scrollTop;
                 if (event.target.tagName === 'OPTION') event.preventDefault();
                 const option = event.target;
                 if (option.tagName === 'OPTION') {
                      option.selected = !option.selected;
                      selectElement.dispatchEvent(new Event('change'));
                      requestAnimationFrame(() => { selectElement.scrollTop = currentScrollTop; });
                 }
             };
             poSelect.addEventListener('mousedown', handleInteraction);
             poSelect.addEventListener('touchstart', handleInteraction, { passive: false });
             poSelect.addEventListener('change', handleMainPOSelectionChange);
             poSelectReserva.addEventListener('mousedown', handleInteraction);
             poSelectReserva.addEventListener('touchstart', handleInteraction, { passive: false });
             poSelectReserva.addEventListener('change', handleReservationSelectionChange);
        });
    </script>
</body>
</html>
